<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA AI Assistant - Debug</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .api-setup {
            display: none;
        }

        .eva-loader-container {
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .eva-loader-container:hover {
            transform: scale(1.05);
        }

        .eva-loader-container:active {
            transform: scale(0.95);
        }

        .eva-loader-container.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .status-text {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            min-width: 250px;
        }

        .conversation-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 400px;
            max-height: 300px;
            overflow-y: auto;
        }

        .conversation-box.hidden {
            display: none;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .message.user {
            background: #e3f2fd;
            text-align: right;
        }

        .message.eva {
            background: #f3e5f5;
            text-align: left;
        }

        .message strong {
            display: block;
            margin-bottom: 5px;
            color: #667eea;
        }

        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 1000;
        }

        .debug-panel .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #333;
        }

        .debug-panel .log-entry.error {
            color: #ff4444;
        }

        .debug-panel .log-entry.success {
            color: #44ff44;
        }

        .debug-panel .log-entry.warning {
            color: #ffaa00;
        }

        .debug-panel .log-entry.info {
            color: #00aaff;
        }

        .modelViewPort {
            perspective: 1000px;
            width: 20rem;
            aspect-ratio: 1;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent;
            overflow: hidden;
        }

        .eva {
            --EVA-ROTATION-DURATION: 4s;
            transform-style: preserve-3d;
            animation: rotateRight var(--EVA-ROTATION-DURATION) linear infinite alternate;
        }

        .head {
            position: relative;
            width: 6rem;
            height: 4rem;
            border-radius: 48% 53% 45% 55% / 79% 79% 20% 22%;
            background: linear-gradient(to right, white 45%, gray);
        }

        .eyeChamber {
            width: 4.5rem;
            height: 2.75rem;
            position: relative;
            left: 50%;
            top: 55%;
            border-radius: 45% 53% 45% 48% / 62% 59% 35% 34%;
            background-color: #0c203c;
            box-shadow: 0px 0px 2px 2px white, inset 0px 0px 0px 2px black;
            transform: translate(-50%, -50%);
            animation: moveRight var(--EVA-ROTATION-DURATION) linear infinite alternate;
        }

        .eye {
            width: 1.2rem;
            height: 1.5rem;
            position: absolute;
            border-radius: 50%;
        }

        .eye:first-child {
            left: 12px;
            top: 50%;
            background: repeating-linear-gradient(65deg, #9bdaeb 0px, #9bdaeb 1px, white 2px);
            box-shadow: inset 0px 0px 5px #04b8d5, 0px 0px 15px 1px #0bdaeb;
            transform: translate(0, -50%) rotate(-65deg);
        }

        .eye:nth-child(2) {
            right: 12px;
            top: 50%;
            background: repeating-linear-gradient(-65deg, #9bdaeb 0px, #9bdaeb 1px, white 2px);
            box-shadow: inset 0px 0px 5px #04b8d5, 0px 0px 15px 1px #0bdaeb;
            transform: translate(0, -50%) rotate(65deg);
        }

        .body {
            width: 6rem;
            height: 8rem;
            position: relative;
            margin-block-start: 0.25rem;
            border-radius: 47% 53% 45% 55% / 12% 9% 90% 88%;
            background: linear-gradient(to right, white 35%, gray);
        }

        .hand {
            position: absolute;
            left: -1.5rem;
            top: 0.75rem;
            width: 2rem;
            height: 5.5rem;
            border-radius: 40%;
            background: linear-gradient(to left, white 15%, gray);
            box-shadow: 5px 0px 5px rgba(0, 0, 0, 0.25);
            transform: rotateY(55deg) rotateZ(10deg);
        }

        .hand:first-child {
            animation: compensateRotation var(--EVA-ROTATION-DURATION) linear infinite alternate;
        }

        .hand:nth-child(2) {
            left: 92%;
            background: linear-gradient(to right, white 15%, gray);
            transform: rotateY(55deg) rotateZ(-10deg);
            animation: compensateRotationRight var(--EVA-ROTATION-DURATION) linear infinite alternate;
        }

        .scannerThing {
            width: 0;
            height: 0;
            position: absolute;
            left: 60%;
            top: 10%;
            border-top: 180px solid #9bdaeb;
            border-left: 250px solid transparent;
            border-right: 250px solid transparent;
            transform-origin: top left;
            mask: linear-gradient(to right, white, transparent 35%);
            display: none;
        }

        .scannerThing.active {
            display: block;
            animation: glow 2s cubic-bezier(0.86, 0, 0.07, 1) infinite;
        }

        .scannerOrigin {
            position: absolute;
            width: 8px;
            aspect-ratio: 1;
            border-radius: 50%;
            left: 60%;
            top: 10%;
            background: #9bdaeb;
            box-shadow: inset 0px 0px 5px rgba(0, 0, 0, 0.5);
            animation: moveRight var(--EVA-ROTATION-DURATION) linear infinite;
            display: none;
        }

        .scannerOrigin.active {
            display: block;
        }

        @keyframes rotateRight {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(25deg); }
        }

        @keyframes moveRight {
            from { transform: translate(-50%, -50%); }
            to { transform: translate(-40%, -50%); }
        }

        @keyframes compensateRotation {
            from { transform: rotateY(55deg) rotateZ(10deg); }
            to { transform: rotatey(30deg) rotateZ(10deg); }
        }

        @keyframes compensateRotationRight {
            from { transform: rotateY(55deg) rotateZ(-10deg); }
            to { transform: rotateY(70deg) rotateZ(-10deg); }
        }

        @keyframes glow {
            from { opacity: 0; }
            20% { opacity: 1; }
            45% { transform: rotate(-25deg); }
            75% { transform: rotate(5deg); }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <h3 style="margin: 0 0 10px 0; color: #fff;">üêõ Debug Console</h3>
        <div id="debugLogs"></div>
    </div>

    <div class="container">
        <!-- API Key Setup -->
        <div class="api-setup" id="apiSetup">
            <h2>ü§ñ Setup Gemini API Key</h2>
            <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API Key">
            <button onclick="saveApiKey()">Start EVA</button>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                Get your free API key at: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
            </p>
        </div>

        <!-- EVA Robot -->
        <div class="eva-loader-container" id="evaContainer">
            <div class="loader">
                <div class="modelViewPort">
                    <div class="eva">
                        <div class="head">
                            <div class="eyeChamber">
                                <div class="eye"></div>
                                <div class="eye"></div>
                            </div>
                        </div>
                        <div class="body">
                            <div class="hand"></div>
                            <div class="hand"></div>
                            <div class="scannerThing" id="scanner"></div>
                            <div class="scannerOrigin" id="scannerOrigin"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="status-text" id="statusText">Click to Talk to EVA</div>
        </div>

        <!-- Conversation History -->
        <div class="conversation-box" id="conversationBox"></div>
    </div>

    <script>
        // Debug Logger
        function debugLog(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            const debugLogs = document.getElementById('debugLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugLogs.appendChild(logEntry);
            debugLogs.scrollTop = debugLogs.scrollHeight;
        }

        // Initialize
        debugLog('üöÄ Application started', 'info');

        // Replace 'YOUR_GEMINI_API_KEY_HERE' with your actual API key
        let apiKey = 'AIzaSyDUYqdvpsJGpJPVmcUIviywtyhXqJ2L1mg';
        debugLog(`API Key loaded: ${apiKey ? '‚úì Present (length: ' + apiKey.length + ')' : '‚úó Missing'}`, apiKey ? 'success' : 'error');

        let isListening = false;
        let recognition = null;

        // Initialize Speech Recognition
        debugLog('üé§ Checking Speech Recognition support...', 'info');
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            debugLog('‚úì Speech Recognition API found', 'success');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            debugLog('‚úì Speech Recognition initialized', 'success');

            recognition.onresult = async (event) => {
                debugLog('üìù Speech recognition result received', 'info');
                const transcript = event.results[0][0].transcript;
                debugLog(`Transcript: "${transcript}"`, 'success');
                debugLog(`Confidence: ${(event.results[0][0].confidence * 100).toFixed(2)}%`, 'info');
                
                addMessage('user', transcript);
                await sendToGemini(transcript);
            };

            recognition.onerror = (event) => {
                debugLog(`‚ùå Speech recognition error: ${event.error}`, 'error');
                console.error('Speech recognition error details:', event);
                updateStatus('Error: ' + event.error);
                stopListening();
            };

            recognition.onend = () => {
                debugLog('üé§ Speech recognition ended', 'info');
                stopListening();
            };

            recognition.onstart = () => {
                debugLog('üé§ Speech recognition started', 'success');
            };
        } else {
            debugLog('‚úó Speech Recognition not supported in this browser', 'error');
        }

        document.getElementById('evaContainer').addEventListener('click', function() {
            debugLog('üëÜ EVA clicked', 'info');

            if (!recognition) {
                debugLog('‚ùå Speech recognition not available', 'error');
                alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
                return;
            }

            if (isListening) {
                debugLog('Stopping listening...', 'warning');
                stopListening();
            } else {
                debugLog('Starting listening...', 'info');
                startListening();
            }
        });

        function startListening() {
            debugLog('‚ñ∂Ô∏è startListening() called', 'info');
            isListening = true;
            document.getElementById('scanner').classList.add('active');
            document.getElementById('scannerOrigin').classList.add('active');
            updateStatus('Listening... Speak now!');
            
            try {
                recognition.start();
                debugLog('‚úì Recognition.start() executed', 'success');
            } catch (e) {
                debugLog(`‚ùå Recognition start error: ${e.message}`, 'error');
                console.error('Recognition start error:', e);
            }
        }

        function stopListening() {
            debugLog('‚èπÔ∏è stopListening() called', 'info');
            isListening = false;
            document.getElementById('scanner').classList.remove('active');
            document.getElementById('scannerOrigin').classList.remove('active');
            updateStatus('Click to Talk to EVA');
        }

        function updateStatus(text) {
            debugLog(`Status updated: "${text}"`, 'info');
            document.getElementById('statusText').textContent = text;
        }

        function addMessage(sender, text) {
            debugLog(`üí¨ Adding message from ${sender}: "${text.substring(0, 50)}..."`, 'info');
            const conversationBox = document.getElementById('conversationBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const label = sender === 'user' ? 'You' : 'EVA';
            messageDiv.innerHTML = `<strong>${label}:</strong>${text}`;
            
            conversationBox.appendChild(messageDiv);
            conversationBox.scrollTop = conversationBox.scrollHeight;
        }

        async function sendToGemini(text) {
            debugLog('üåê sendToGemini() called', 'info');
            debugLog(`Input text: "${text}"`, 'info');
            updateStatus('EVA is thinking...');
            
            // Build the URL - Use v1beta API version with correct model name
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
            debugLog(`Request URL: ${url.substring(0, 80)}...`, 'info');
            
            // Build the request body
            const requestBody = {
                contents: [{
                    parts: [{
                        text: text
                    }]
                }]
            };
            debugLog(`Request body: ${JSON.stringify(requestBody)}`, 'info');
            
            try {
                debugLog('üì§ Sending fetch request...', 'info');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                debugLog(`üì• Response received - Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                debugLog(`Response headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    debugLog(`‚ùå Response error body: ${errorText}`, 'error');
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                debugLog(`‚úì Response JSON parsed successfully`, 'success');
                debugLog(`Response data structure: ${JSON.stringify(Object.keys(data))}`, 'info');
                
                // Check if response has expected structure
                if (!data.candidates || !data.candidates[0]) {
                    debugLog(`‚ùå Unexpected response structure: ${JSON.stringify(data)}`, 'error');
                    throw new Error('Unexpected API response structure');
                }
                
                const reply = data.candidates[0].content.parts[0].text;
                debugLog(`‚úì Reply extracted: "${reply.substring(0, 100)}..."`, 'success');
                
                addMessage('eva', reply);
                speak(reply);
            } catch (error) {
                debugLog(`‚ùå Gemini API Error: ${error.message}`, 'error');
                debugLog(`Error stack: ${error.stack}`, 'error');
                console.error('Gemini API Error:', error);
                const errorMsg = 'Sorry, I encountered an error. Check debug panel for details.';
                addMessage('eva', errorMsg);
                speak(errorMsg);
            }
        }

        function speak(text) {
            debugLog('üîä speak() called', 'info');
            debugLog(`Text to speak: "${text.substring(0, 50)}..."`, 'info');
            updateStatus('EVA is speaking...');
            
            // Check if speech synthesis is available
            if (!window.speechSynthesis) {
                debugLog('‚ùå Speech Synthesis not available', 'error');
                return;
            }
            
            // Cancel any ongoing speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                debugLog('üîá Cancelled previous speech', 'info');
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1.0;
            utterance.pitch = 1.2;
            utterance.volume = 1.0;
            
            // Wait for voices and select a female voice
            const voices = speechSynthesis.getVoices();
            debugLog(`Available voices: ${voices.length}`, 'info');
            
            // Try to find a female voice
            const femaleVoice = voices.find(voice =>
                voice.lang.startsWith('en') && voice.name.toLowerCase().includes("female")
            ) || voices.find(voice =>
                voice.lang.startsWith('en') && (
                    voice.name.includes("Google") || 
                    voice.name.includes("Samantha") || 
                    voice.name.includes("Jenny") ||
                    voice.name.includes("Zira") ||
                    voice.name.includes("Susan")
                )
            );
            
            if (femaleVoice) {
                utterance.voice = femaleVoice;
                debugLog(`‚úì Using voice: ${femaleVoice.name} (${femaleVoice.lang})`, 'success');
            } else {
                debugLog(`‚ö†Ô∏è No female voice found, using default`, 'warning');
            }
            
            debugLog(`Utterance settings - Rate: ${utterance.rate}, Pitch: ${utterance.pitch}, Volume: ${utterance.volume}`, 'info');
            
            utterance.onstart = () => {
                debugLog('üîä Speech started', 'success');
            };
            
            utterance.onend = () => {
                debugLog('üîä Speech ended', 'success');
                updateStatus('Click to Talk to EVA');
            };
            
            utterance.onerror = (event) => {
                debugLog(`‚ùå Speech synthesis error: ${event.error}`, 'error');
            };
            
            window.speechSynthesis.speak(utterance);
            debugLog('‚úì Speech synthesis initiated', 'success');
        }

        // Ensure voices are loaded
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                const voices = speechSynthesis.getVoices();
                debugLog(`üîä Voices loaded: ${voices.length} available`, 'success');
                voices.forEach((voice, i) => {
                    if (i < 5) { // Log first 5 voices
                        debugLog(`  Voice ${i}: ${voice.name} (${voice.lang})`, 'info');
                    }
                });
            };
        }

        debugLog('‚úì All event listeners registered', 'success');
        debugLog('üéØ Ready for interaction!', 'success');
    </script>
</body>
</html>